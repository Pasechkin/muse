# Защита репозитория GitHub от изменений

## Введение

Этот документ описывает, как настроить GitHub-репозиторий так, чтобы никто не мог вносить изменения в код без вашего одобрения.

---

## 1. Настройка прав доступа к репозиторию

### Приватный репозиторий (рекомендуется)

Если вы хотите полностью контролировать доступ к коду:

1. Откройте репозиторий на GitHub
2. Перейдите в **Settings** (Настройки)
3. В разделе **General** → **Danger Zone**
4. Найдите **Change repository visibility**
5. Нажмите **Change visibility** → выберите **Make private**

**Преимущества:**
- Только вы и приглашенные участники видят код
- Полный контроль над доступом
- Никто не может создавать форки (forks) публично

### Управление участниками

Если репозиторий приватный или публичный, вы можете управлять правами доступа:

1. **Settings** → **Collaborators and teams**
2. Здесь видны все участники с доступом к репозиторию
3. Уровни доступа:
   - **Read** — только просмотр
   - **Write** — могут создавать ветки и PR, но не могут пушить напрямую в защищенные ветки
   - **Admin** — полный доступ

**Рекомендация:** Давайте участникам только **Read** или **Write**, оставьте **Admin** только себе.

---

## 2. Защита веток (Branch Protection Rules)

Это **основной механизм** защиты кода. Даже если у участника есть права Write, он не сможет напрямую пушить в защищенную ветку.

### Настройка защиты главной ветки

1. Перейдите в **Settings** → **Branches**
2. Нажмите **Add branch protection rule**
3. В поле **Branch name pattern** укажите `main` (или `master`, если используете её)
4. Включите следующие настройки:

#### Обязательные настройки

✅ **Require a pull request before merging** (Требовать Pull Request перед слиянием)
   - Это заставит всех, включая администраторов, создавать PR вместо прямого пуша
   - Включите подопцию: **Require approvals** (укажите количество необходимых одобрений, например 1)
   - Включите: **Dismiss stale pull request approvals when new commits are pushed** (сбрасывать одобрения при новых коммитах)

✅ **Require status checks to pass before merging** (Требовать успешного прохождения проверок)
   - Если у вас настроены GitHub Actions или другие CI/CD
   - Включите: **Require branches to be up to date before merging**

✅ **Require conversation resolution before merging** (Требовать разрешения всех комментариев)
   - Гарантирует, что все замечания в PR обсуждены

✅ **Do not allow bypassing the above settings** (Не позволять обходить эти настройки)
   - Даже администраторы не смогут обойти правила

#### Дополнительные настройки (по желанию)

⚙️ **Require linear history** (Требовать линейную историю)
   - Запрещает merge commits, только rebase или squash

⚙️ **Require deployments to succeed before merging** (Требовать успешного деплоя)
   - Если используете автодеплой

⚙️ **Lock branch** (Заблокировать ветку)
   - Делает ветку полностью read-only
   - Никто не сможет создать PR в эту ветку
   - **Внимание:** Это полностью блокирует изменения!

⚙️ **Restrict who can push to matching branches** (Ограничить, кто может пушить)
   - Можно указать конкретных пользователей или команды
   - Полезно, если у вас есть доверенные участники

5. Нажмите **Create** или **Save changes**

### Защита других веток

Повторите процесс для других важных веток:
- `develop`
- `production`
- Или используйте паттерн `release/*` для защиты всех веток релизов

---

## 3. Отключение форков и PR от незнакомцев (для публичных репозиториев)

Если репозиторий публичный, по умолчанию любой может создать fork и отправить Pull Request.

### Ограничение PR от внешних участников

1. **Settings** → **General** → **Pull Requests**
2. **Отключите:** Allow merge commits, Allow squash merging, Allow rebase merging (по желанию)
3. В **Moderation options** можно настроить:
   - **Limit interactions** (Временно ограничить взаимодействия)

### Запрет форков (нельзя полностью отключить для публичных)

GitHub не позволяет полностью запретить форки для публичных репозиториев. 

**Решение:**
- Сделайте репозиторий **приватным** (см. раздел 1)
- Или примите, что форки будут, но без защиты веток они не смогут влиять на ваш основной код

---

## 4. Настройка GitHub Actions для автоматических проверок

Добавьте автоматические проверки, которые будут запускаться при каждом PR:

### Пример: Проверка сборки CSS

Файл `.github/workflows/check-build.yml`:

```yaml
name: Check Build

on:
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build CSS
        run: npm run build:once
      
      - name: Check for errors
        run: |
          if [ ! -f "src/css/output.css" ]; then
            echo "Build failed: output.css not found"
            exit 1
          fi
```

Затем в **Branch Protection Rules** включите:
- **Require status checks to pass before merging**
- Отметьте чекбокс напротив вашего workflow (например, `Check Build`)

---

## 5. Использование CODEOWNERS

Файл `CODEOWNERS` позволяет указать, кто должен одобрить изменения в определенных файлах или папках.

### Создание CODEOWNERS

Создайте файл `.github/CODEOWNERS`:

```
# Все файлы требуют одобрения владельца
* @Pasechkin

# Особо важные файлы
/src/input.css @Pasechkin
/package.json @Pasechkin
/.github/ @Pasechkin

# Можно указать отдельных владельцев для разных папок
/docs/ @Pasechkin
/src/html/ @Pasechkin
```

После создания CODEOWNERS:

1. В **Branch Protection Rules** включите:
   - **Require review from Code Owners** (Требовать одобрения от владельцев кода)

---

## 6. Настройка уведомлений

Чтобы всегда знать о попытках изменений:

1. **Settings** → **Notifications** (в личном профиле GitHub)
2. Включите уведомления о:
   - Pull requests
   - Issues
   - Push events (если важно)
3. Выберите способ: Email или Web notifications

---

## 7. Двухфакторная аутентификация (2FA)

Защитите свой аккаунт от несанкционированного доступа:

1. Профиль → **Settings** → **Password and authentication**
2. **Enable two-factor authentication**
3. Выберите метод: SMS, Authenticator app (рекомендуется), или Security key

**Важно:** Если кто-то получит доступ к вашему аккаунту, 2FA — последняя линия защиты.

---

## 8. Аудит и мониторинг

### Проверка доступа

Регулярно проверяйте:

1. **Settings** → **Collaborators and teams** — кто имеет доступ
2. **Settings** → **Branches** — действуют ли правила защиты
3. **Insights** → **Network** — графическое представление веток и коммитов

### Аудит активности

1. **Insights** → **Pulse** — активность за последнее время
2. **Security** → **Security overview** — потенциальные проблемы безопасности

---

## 9. Быстрая настройка (рекомендуемая конфигурация)

### Для полной защиты выполните:

1. ✅ Сделайте репозиторий **приватным** (если возможно)
2. ✅ Настройте **Branch Protection** для `main`:
   - Require pull request with 1 approval
   - Require status checks (если есть CI/CD)
   - Do not allow bypassing
3. ✅ Создайте файл `.github/CODEOWNERS` и укажите себя владельцем
4. ✅ Включите **2FA** на своём GitHub-аккаунте
5. ✅ Настройте **уведомления** о PR и изменениях

---

## 10. Что происходит после настройки

### Для участников с доступом Write

Они **не смогут**:
- Напрямую пушить в `main` (или другие защищенные ветки)
- Мерджить PR без одобрения
- Обходить правила защиты веток

Они **смогут**:
- Создавать feature-ветки (например, `feature/my-changes`)
- Пушить в свои ветки
- Создавать Pull Requests в `main`

### Для вас (владельца)

Вы будете:
- Получать уведомления о каждом PR
- Видеть все предложенные изменения до их применения
- Иметь возможность запросить изменения или отклонить PR
- Контролировать каждое изменение в защищенных ветках

---

## 11. Пример рабочего процесса

### Сценарий: Участник хочет внести изменения

1. Участник создаёт новую ветку: `git checkout -b feature/new-page`
2. Вносит изменения и коммитит: `git commit -am "Add new page"`
3. Пушит ветку: `git push origin feature/new-page`
4. Создаёт Pull Request на GitHub из `feature/new-page` в `main`
5. **Вы получаете уведомление** о новом PR
6. Вы проверяете изменения, оставляете комментарии
7. Если всё в порядке — одобряете (Approve) и мерджите
8. Если нет — запрашиваете изменения (Request changes)

### Важно

Участник **не может** просто сделать:
```bash
git checkout main
git add .
git commit -m "My changes"
git push origin main  # ❌ Будет отклонено GitHub!
```

GitHub ответит: `remote: error: GH006: Protected branch update failed`

---

## 12. Часто задаваемые вопросы

### Q: Я хочу, чтобы НИКТО не мог вообще ничего менять

**A:** Сделайте репозиторий приватным и не добавляйте участников. Если нужна полная блокировка даже для себя — используйте `Lock branch` в Branch Protection, но учтите, что тогда вы тоже не сможете вносить изменения без снятия блокировки.

### Q: Можно ли разрешить изменения только мне?

**A:** Да. В Branch Protection Rules используйте:
- **Restrict who can push to matching branches**
- Укажите только своё имя пользователя

### Q: Как защититься от случайного удаления репозитория?

**A:** GitHub требует подтверждения при удалении. Дополнительно:
- Регулярно делайте бэкапы (clone в другое место)
- Используйте 2FA

### Q: У меня публичный репозиторий, но я не хочу принимать чужие PR

**A:** 
- Включите Branch Protection с обязательным одобрением
- Просто не одобряйте и не мерджите нежелательные PR
- Или сделайте репозиторий приватным

---

## 13. Дополнительные ресурсы

- [GitHub Docs: About protected branches](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches)
- [GitHub Docs: Managing a branch protection rule](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/managing-a-branch-protection-rule)
- [GitHub Docs: About code owners](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners)

---

## Заключение

Следуя этим рекомендациям, вы надежно защитите свой репозиторий от несанкционированных изменений. Основные механизмы:

1. **Приватный репозиторий** — ограничивает видимость
2. **Branch Protection Rules** — контролирует изменения в важных ветках
3. **CODEOWNERS** — требует ваше одобрение
4. **2FA** — защищает ваш аккаунт
5. **Уведомления** — держат вас в курсе всех событий

Помните: GitHub предоставляет гибкие инструменты защиты, используйте их в зависимости от ваших потребностей!
