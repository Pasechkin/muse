# Проект Muse — Переверстка на Tailwind CSS

> **Для ИИ-агента:** Перед созданием новой страницы прочитай [AI_INSTRUCTIONS.md](AI_INSTRUCTIONS.md)

## О проекте

Переверстать сайт **www.muse.ooo** с Bootstrap 3 (тема Stack) на Tailwind CSS.

**Стек:** HTML5, Tailwind CSS v4, Vanilla JS — без фреймворков.

**Ключевые требования:**
- Сохранить визуальный стиль оригинала
- Деплой: GitHub → Vercel
- Интеграцию будет делать программист отдельно

---

## Прогресс

**Обновлено:** 9 февраля 2026

| Категория | Готово | Всего |
|-----------|--------|-------|
| Главные страницы | 4 | 4 |
| Стили портретов | 18 | 18 |
| Объекты портретов | 5 | 5 |
| Блог | 20 | 20 |
| Info | 9 | 9 |
| Прочие страницы | 0 | 14 |
| **Итого** | **56** | **70** |

**⏳ Осталось:** 14 страниц → [Ожидают переверстки](#ожидают-переверстки)

### Что сделано

- ✅ Типографика v2 — семантические классы (`heading-*`, `text-lead`, `text-body`, `text-small`)
- ✅ Цветовая палитра → [docs/DESIGN_SYSTEM.md](docs/DESIGN_SYSTEM.md#colors)
- ✅ Дизайн-система v2 — Tailwind v4 + `@layer components` → [компоненты](docs/DESIGN_SYSTEM.md#components)
- ✅ Навигация — унифицированы header/footer/page-navigator → [подробнее](docs/DES IGN_SYSTEM.md#header)
- ✅ DRY — повторяющиеся стили вынесены в `input.css`
- ✅ Скрипты — `js/nav.js` → [подробнее](docs/DESIGN_SYSTEM.md#скрипты-navjs)

### Эталоны

| Группа | Эталонный файл |
|--------|----------------|
| Главные | [index.html](src/html/index.html) |
| Стили портретов | [portret-maslom.html](src/html/portret-na-zakaz/style/portret-maslom.html) |
| Объекты портретов | [muzhskoy-portret.html](src/html/portret-na-zakaz/object/muzhskoy-portret.html) |
| Блог | [kollazh-i-fotokollazh.html](src/html/blog/kollazh-i-fotokollazh.html) |
| Info | [kontakty.html](src/html/info/kontakty.html) |

---

## Структура проекта

```
tailwind-project/
├── src/
│   ├── input.css           # Исходный CSS (редактировать здесь)
│   ├── css/output.css      # Результат сборки
│   └── html/               # HTML страницы
│       ├── css/output.css  # Копия для Live Server
│       └── js/nav.js       # Скрипты UI
├── docs/                   # Документация
└── package.json
```

---

## Техническая часть

### CSS
- **Tailwind v4** — локальная сборка (без CDN)
- **Редактировать:** `src/input.css` (через `@theme` и `@layer`)
- **Не редактировать:** `output.css` (генерируется автоматически)
- **Critical CSS:** не используем, кроме исключений (info-страницы)

Скрипты сборки описаны в package.json в разделе scripts: npm run build:once запускает PostCSS и собирает output.css, а npm run copy-css копирует output.css и page-info.css в папку src/html/css/ для предпросмотра.

### Скрипты
- **Основной:** `src/html/js/nav.js`
- **Inline:** только для уникальной логики страницы
- **Legacy:** при обновлении удалять `el-*` fallback-скрипты

### Предпросмотр
- **Использовать:** Live Server из папки `src/html/`
- **URL:** `http://127.0.0.1:5501/имя-страницы.html`
- **Не использовать:** альтернативные сервера (могут быть неверные стили)

---

## Деплой

**Быстрый способ:** запустить `БЫСТРЫЙ_ДЕПЛОЙ.ps1`

**Команды:**
```bash
npm run build:once   # Сборка CSS
npm run copy-css     # Копия для Live Server
```

**Production:** ветка `main` → Vercel (автодеплой)

**Ссылки:**
- Vercel: https://muse-liard-one.vercel.app/
- Оригинал: https://muse.ooo

### Защита от индексации
Все страницы закрыты (`robots.txt` + `<meta name="robots">`).
Убрать защиту только после переноса на production.

---

## Следующие шаги

### Приоритетные задачи
- калькулятор для страницы фото на холсте  `foto-na-kholste-sankt-peterburg.html`
. ⏳ Переверстать оставшиеся 14 страниц (см. [Ожидают переверстки](#ожидают-переверстки))
. ⏳ Подготовить сборку для продакшена
. ⏳ Подготовить материалы для интеграции

### Проверки качества
- ⏳ **Контент** — сверка текстов/SEO/alt/title с muse.ooo (ничего не терять!)
- ⏳ **Визуал** — контраст, читаемость, соответствие оригиналу
- ⏳ **Функционал** — скрипты, видео, интерактив
- ⏳ **Калькуляторы** — верстка страниц с калькуляторами

**Аудиты:** `docs/AUDIT/` → Task-1.md, Task-234.md, Task-COMPLETE.md

---

## Ресурсы

- **Оригинал:** https://muse.ooo
- **Vercel:** https://muse-liard-one.vercel.app/
- **Документация:** `docs/`
- **Интеграция:** [docs/INTEGRATION_BITRIX.md](docs/INTEGRATION_BITRIX.md)

---

## Готовые страницы (56)

### Главные (4) ✅
`index.html`, `portret-na-zakaz-po-foto-na-kholste-sankt-peterburg.html`, `pechat-na-kholste-sankt-peterburg.html`, `foto-na-kholste-sankt-peterburg.html`

### Стили портретов (18) ✅
Все файлы в `src/html/portret-na-zakaz/style/`

### Объекты портретов (5) ✅
Все файлы в `src/html/portret-na-zakaz/object/`

### Блог (20) ✅
Все файлы в `src/html/blog/`

### Info (9) ✅
`faq.html`, `kontakty.html`, `info.html`, `avtorstvo.html`, `guarantee.html`, `partnerstvo.html`, `oferta.html`, `politika-konfidentsialnosti-sayta.html`, `dostavka.html`

---

## Ожидают переверстки (14)

| Страница | URL | Приоритет |
|----------|-----|-----------|
| Портреты Москва | `/portret-na-zakaz-po-foto-na-kholste-moskva/` | Средний |
| Печать Москва | `/pechat-na-kholste-moskva/` | Средний |
| Оплата | `/info/oplata/` | Средний |
| Форма заказа | `/order/` | Средний |
| Спасибо за заказ | — | Низкий |
| Страница заказчика | `/personal/orders/...` | Средний |
| Подарочный сертификат | `/pechat/podarochnyy-sertifikat/` | Средний |
| Страница 404 | `/404/` | Низкий |
| Страница художника | `/personal/forart/...` | Средний |
| Модульная картина | `/pechat/modulnaya-kartina/` | С калькулятором |
| Фотоколлаж на холсте | `/pechat/fotokollazh-na-kholste/` | С калькулятором |
| Фото в рамке | `/pechat/foto-v-ramke/` | С калькулятором |
| Фотоколлаж в рамке | `/pechat/fotokollazh-v-ramke/` | С калькулятором |
| Репродукция | `/pechat/reproduktsiya/` | С поиском |

### UI-компоненты (ожидают)
- Куки-баннер
- «Это ваш город?»
- Виджет отзывов
### Калькуляторы и конструкоры
- калькулятор для страницы фото на холсте  `foto-na-kholste-sankt-peterburg.html`
- калькултор для страниц стили портретов
- калькулятор для страниц объекты портретов
- калькулятор для странцы портрет на заказ
- калькулятор для страницы фото в рамке
- конструктор для фотоколлажа
- контрсуктор для модульных картин
---

## Черновики

Файлы в `src/html/_drafts/` — тесты и эксперименты, не учитываются в статистике.

---

## Лог работ: Калькулятор

### Сессия 1 — Создание калькулятора (февраль 2026)

**Файлы:** `js/calc.js`, секция `#calc` в `foto-na-kholste-sankt-peterburg.html`, `calc.html` (демо)

- ✅ Создан универсальный JS-компонент `CalcInit()` (~850 строк) с публичным API и конфигурацией через объект
- ✅ Визуализатор — превью картины на фоне интерьера, бейджи размеров, загрузка/замена/удаление фото
- ✅ Панель настроек — размер (ручной ввод + пресеты 4×3), печать/подрамник, обработка фото, выбор багета, лак, подарочная упаковка
- ✅ На этапе Сессии 1 были добавлены скрытые секции-расширения для портретных страниц — кол-во лиц, гель, акрил, масло, поталь, цифровой макет (legacy feature flags; удалены в Сессии 3)
- ✅ Каталог багетов — 27 рамок (студийные + классические) в модальном окне с превью
- ✅ Расчёт цены — по площади холста, периметру, выбранным опциям
- ✅ Сохранение состояния в localStorage
- ✅ Проверка DPI загруженного фото
- ✅ Форма заказа с валидацией (имя, телефон, email, ссылка, комментарий)
- ✅ Мобильный sticky-бар с ценой и кнопкой «Заказать»
- ✅ Lightbox для просмотра превью
- ✅ Интеграция в `foto-na-kholste-sankt-peterburg.html` с актуальным конфигом `CalcInit({ type: 'canvas' })` (опционально: `prices`, `frames`, `sizePresets`, `interiors`)

### Сессия 2 — Доработка калькулятора (11 февраля 2026)

- ✅ Динамические бейджи «Печать и подрамник» — «ВКЛЮЧЕНО» для стандартного/рулона, «+N ₽» для толстого подрамника (`gallerySurchargePerM: 300`)
- ✅ Динамические бейджи «Обработка фото» — «ВКЛЮЧЕНО» для базовой, «+300 ₽» / «+900 ₽» для оптимальной/премиальной
- ✅ Замена фона визуализатора на `https://muse.ooo/upload/imgsite/canvas-628-398.webp` (628×398)
- ✅ Удаление 3 unsplash-интерьеров (Гостиная, Детская, Офис) — оставлен 1 фон
- ✅ Удаление панели выбора интерьеров из HTML (обе страницы)
- ✅ Исправления доступности по отчёту Lighthouse (score 0.75 → ~1.0):
  - `aria-label` для чекбоксов `toggle-varnish`, `toggle-gift`
  - `aria-label` для `processing-select`
  - Обёртка `<main>` в `calc.html`
- ✅ Кнопки «Заказать» переведены на класс `btn-header-cta` (существующий в `input.css`)
- ✅ Шрифт итоговой цены выровнен с заголовком «Цена» (`font-extrabold` → `font-bold`)

### Сессия 3 — Компонентный рефакторинг (13 февраля 2026)

- ✅ `calc.html` приведён к компонентному подходу Tailwind v4: добавлены классы `.calc-panel`, `.calc-sticky-bar`, `.calc-order-form`, `.calc-preview-canvas`, `.calc-lightbox-close`
- ✅ Модалка багета переведена на нативный `<dialog>` + `showModal()` / `close()` в `js/calc.js`
- ✅ Для модалки багета добавлены компонентные классы: `.modal-shell`, `.calc-frame-modal-content`, `.calc-frame-modal-header`, `.calc-frame-modal-body`, `.calc-frame-upload-cta`, `.calc-frame-modal-footer`
- ✅ Убран избыточный JS в `js/calc.js` (legacy feature flags, лишние проверки, дубли присвоения классов бейджам)
- ✅ Обновлена документация в `docs/DESIGN_SYSTEM.md` под текущее состояние калькулятора
- ℹ️ Для актуального предпросмотра после CSS-правок: `npm run build:once` + `npm run copy-css`

---

## CALC — стратегия калькуляторов (бизнес + техчасть)

### Зачем нужна отдельная глава

Мы переводим сайт **www.muse.ooo** с Bootstrap 3 на Tailwind CSS 4.
Калькуляторы — критичная часть воронки продаж: в разделе «Цена» пользователь загружает фото, выбирает параметры (размер, подрамник, багет, покрытие, работу художника) и получает итоговую стоимость.

Исторически калькуляторы управлялись отдельной системой (вне текущего репозитория). Сейчас логика частично перенесена в этот проект и нужно зафиксировать единый подход, чтобы корректно масштабировать решение на все целевые страницы.

---

### Для неспециалистов (простое объяснение)

#### Как было раньше
- На старом сайте калькуляторы работали как отдельный внешний модуль.
- Настройки менялись из отдельной админки: цены, виды калькуляторов, доступные поля, багеты, покрытия и дополнительные услуги.
- Это позволяло быстро менять бизнес-правила без ручной правки каждой страницы.

#### Что есть сейчас
- В текущем Tailwind-проекте уже сделан свой калькулятор:
  - демонстрационная страница: `src/html/calc.html`
  - логика: `src/html/js/calc.js`
  - загрузчик фото: `src/html/js/uploader.js`
- На странице фото на холсте (`src/html/foto-na-kholste-sankt-peterburg.html`) калькулятор уже подключён.
- На 23 страницах портретов пока в основном стоит заглушка под будущую интеграцию.

#### Что планируется
- Использовать **один общий калькулятор** для всех страниц с разделом «Цена».
- Отличия между страницами задавать через настройки (цены, опции, надбавки за художника, покрытия, багеты).
- Настройки получать с сервера (из админки), но оставить резервные локальные данные, чтобы калькулятор не падал при проблемах API.

#### Почему это важно
- Меньше дублирования кода и ручной работы.
- Единый принцип расчёта цен.
- Быстрее запуск новых страниц.
- Проще поддержка и обновления.

---

### Для специалистов (техническая часть)

#### 1) Текущее состояние
- Эталонная компонентная разметка калькулятора: `src/html/calc.html`.
- Runtime-движок: `src/html/js/calc.js` (`CalcInit(cfg)`).
- Компонентные стили калькулятора: `src/input.css`.
- Документированные классы и паттерны: `docs/DESIGN_SYSTEM.md` (раздел «Калькулятор»).

#### 2) Зафиксированные расхождения
- В `src/html/foto-na-kholste-sankt-peterburg.html` используется рабочий калькулятор, но часть структуры исторически legacy и отличается от эталонной `calc.html`.
- В `docs/INTEGRATION_BITRIX.md` описан сценарий «заглушка для калькулятора Bitrix», а в проекте уже есть локальный рабочий runtime.
- На страницах `src/html/portret-na-zakaz/**` секции `#calc` в большинстве случаев пока placeholders.

#### 3) Целевая архитектура (принятое направление)
- Один frontend runtime (`calc.js`) для всех продуктовых страниц.
- Один DOM-контракт калькулятора (source-of-truth: `src/html/calc.html`).
- Различия между страницами — через page-config по slug:
  - `productType`
  - `prices`
  - `frames`
  - `sizePresets`
  - `processingOptions`
  - `artistOptions` (лица/прорисовка/покрытия)
- Серверный источник конфигов (админка/API) + обязательный fallback на локальные `DEFAULT_*` в `calc.js`.

#### 4) Что считается оптимальным
Оптимально: единый калькулятор + конфигурация + серверное управление правилами.

Неоптимально:
- поддерживать несколько несовместимых DOM-версий калькулятора;
- копировать JS-логику в каждую из 23 страниц;
- оставлять смешанный режим «часть страниц с runtime, часть только с заглушками» надолго.

---

### Варианты серверной реализации

#### Вариант A (рекомендуется)
**API-конфиг + расчёт на фронте.**
- Сервер отдаёт правила и цены.
- Фронт считает цену локально.
- Плюсы: быстро, гибко, удобно масштабировать.

#### Вариант B
**Полный серверный расчёт цены (каждое изменение опции → запрос к API).**
- Плюсы: строгий контроль формул.
- Минусы: выше задержки, выше нагрузка, сложнее UX.

#### Вариант C
**Полный калькулятор как Bitrix-компонент.**
- Плюсы: логика централизована в CMS.
- Минусы: ниже переносимость, больше связность с Bitrix-шаблоном.

#### Вариант D (текущий компромисс, file-based)
**Цены и опции из локального файла, сервер — только для рендера багета.**
- Все правила калькулятора (цены, наборы полей, надбавки, покрытия) хранятся в конфиг-файле репозитория.
- При изменениях правим конфиг, делаем commit/deploy, страницы получают новые значения из файла.
- Серверная часть используется точечно: только там, где нужен серверный функционал (например, рендер/превью багета).

Когда подходит:
- изменения не слишком частые;
- нет требования менять цены мгновенно из админки;
- важна простая и прозрачная поддержка без API-зависимости.

Ограничения:
- каждое изменение требует релиза;
- выше риск человеческой ошибки при ручном обновлении конфигов;
- нет «моментального» бизнес-управления без участия разработчика.

Условия перехода на API в будущем:
- частые изменения цен/опций;
- необходимость обновлять правила без деплоя;
- рост количества продуктовых сценариев и маркетинговых акций.

Мини-инструкция (для менеджера, 1–2 минуты):

Кто участвует:
- **Менеджер/маркетинг:** формирует список изменений (что поменять и с какой даты).
- **Разработчик:** вносит изменения в конфиг-файл, проверяет и публикует.

Как обновляется (пошагово):
1. Менеджер отправляет задачу: какие цены/опции/надбавки меняются.
2. Разработчик обновляет локальный конфиг калькулятора в репозитории.
3. Разработчик проверяет, что калькулятор корректно считает цену на ключевых страницах.
4. Изменения публикуются (commit + deploy).
5. Менеджер открывает 2–3 контрольные страницы и сверяет итоговые суммы.

Что важно фиксировать в задаче:
- дата начала действия новых цен;
- какие страницы затрагиваются;
- какие параметры изменены (цены, багет, покрытия, услуги художника);
- кто подтвердил финальную проверку после публикации.

Когда задача считается завершённой:
- новые значения видны на сайте;
- расчёт совпадает с согласованной таблицей;
- багетный модуль работает штатно;
- в журнале задач есть отметка о проверке.

---

### Риски и как их снижать

- **Риск 1:** дрейф разметки между страницами.
  - **Мера:** единый DOM-контракт и чеклист обязательных id/class.

- **Риск 2:** разные формулы цены на разных страницах.
  - **Мера:** один runtime и единый слой конфигов.

- **Риск 3:** API временно недоступен.
  - **Мера:** fallback на локальные данные, graceful degradation.

- **Риск 4:** противоречия в документации.
  - **Мера:** синхронизировать `PROJECT.md`, `docs/INTEGRATION_BITRIX.md`, `docs/DESIGN_SYSTEM.md` после каждого этапа внедрения.

---

### План внедрения (rollout)

1. **Пилот:** привести секцию `#calc` в `foto-na-kholste-sankt-peterburg.html` к эталонному DOM-контракту `calc.html`.
2. **Конфиги:** внедрить page-config по slug для продуктовых различий.
3. **API:** подключить серверный источник конфигов с fallback на `DEFAULT_*`.
4. **Тиражирование:** подключить калькулятор на 23 страницах `src/html/portret-na-zakaz/**` батчами.
5. **Расширение:** подключить на дополнительных страницах (например, `pechat-na-kholste-sankt-peterburg.html`, фото в рамке, фотоколлаж, модульные картины).
6. **Документация:** обновить интеграционные разделы и зафиксировать итоговый стандарт подключения.

---

### Definition of Done для CALC

- Единый шаблон разметки и единый runtime используются на всех целевых страницах.
- Все продуктовые различия задаются конфигами, а не копипастой JS/HTML.
- Серверные конфиги работают, fallback проверен.
- Базовые пользовательские сценарии стабильны на desktop/mobile:
  - выбор параметров
  - пересчёт цены
  - загрузка фото
  - отправка формы
- Документация не содержит противоречий между «заглушкой» и рабочей реализацией.

---

### Текущее решение (13 февраля 2026)

Принято рабочее направление:
- источник истины по DOM калькулятора — `src/html/calc.html`;
- масштабирование — один runtime + page-config;
- интеграция с админкой — API-first с локальным fallback;
- старт миграции — страница `foto-na-kholste-sankt-peterburg.html`, далее 23 страницы портретов.

---

### Реестр подключений CALC (23 страницы `portret-na-zakaz`)

Статусы:
- `placeholder` — в секции `#calc` стоит заглушка, runtime не подключён.
- `pilot-ready` — страница выбрана как кандидат на раннюю интеграцию после пилота.
- `integrated` — калькулятор подключён и работает по целевому стандарту.

| Страница | Тип | Текущий статус | Следующий шаг | Приоритет |
|---|---|---|---|---|
| `src/html/portret-na-zakaz/style/portret-maslom.html` | style | `pilot-ready` | Заменить placeholder на общий calc-блок по контракту `calc.html` | Высокий |
| `src/html/portret-na-zakaz/style/portret-akvarelyu.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Высокий |
| `src/html/portret-na-zakaz/style/portret-karandashom.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/sharzh-po-foto.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/portret-v-obraze.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/portret-komiks.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/portret-iz-slov.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/portret-flower-art.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/fantasy-art-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/low-poly-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/graffiti-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/beauty-art-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/granzh-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/wpap-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/pop-art-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/drim-art-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/style/fotomozaika.html` | style | `placeholder` | Подключить общий calc-блок + отдельный page-config (особые параметры) | Средний |
| `src/html/portret-na-zakaz/style/love-is-portret.html` | style | `placeholder` | Подключить общий calc-блок + page-config стиля | Средний |
| `src/html/portret-na-zakaz/object/muzhskoy-portret.html` | object | `placeholder` | Подключить общий calc-блок + page-config объекта | Средний |
| `src/html/portret-na-zakaz/object/zhenskiy-portret.html` | object | `placeholder` | Подключить общий calc-блок + page-config объекта | Средний |
| `src/html/portret-na-zakaz/object/detskiy-portret.html` | object | `placeholder` | Подключить общий calc-блок + page-config объекта | Средний |
| `src/html/portret-na-zakaz/object/parnyy-portret.html` | object | `placeholder` | Подключить общий calc-блок + page-config объекта | Средний |
| `src/html/portret-na-zakaz/object/semeynyy-portret.html` | object | `placeholder` | Подключить общий calc-блок + page-config объекта | Средний |

Порядок rollout по батчам:
- **Batch 1 (пилот):** `foto-na-kholste-sankt-peterburg.html` + `portret-maslom.html`
- **Batch 2:** 5 style-страниц
- **Batch 3:** 5 style-страниц
- **Batch 4:** оставшиеся style + 5 object-страниц

---

## Аудит: Архитектура калькуляторов (13 февраля 2026)

> Независимая проверка. Только research, без правок файлов.
> Источники: локальный проект + live-сайт muse.ooo.

---

### A. Как было раньше и как сейчас

#### Для менеджера

| | Старая версия (production muse.ooo) | Новая версия (Tailwind-проект) |
|---|---|---|
| **Движок** | Калькулятор встроен как серверный компонент 1С-Битрикс, рендерится на стороне сервера | Полностью клиентский JS-калькулятор `calc.js` (865 строк) |
| **Цены** | Из базы Битрикс (обновляются через админку) | Захардкожены в JS-файле |
| **Багеты** | Из базы Битрикс | 27 рамок описаны как массив в JS-файле |
| **framemuse.ru** | Просто редирект на muse.ooo — НЕ отдельный сервис | Не используется, упоминаний нет |
| **iframe** | Не используется | Не используется |
| **Загрузка фото** | Bitrix-форма | Свой компонент `uploader.js` (drag-and-drop, валидация, ARIA) |

#### Для разработчика

Production (muse.ooo) — 1С-Битрикс; пути `/bitrix/` и `/local/` отвечают 403, подтверждая наличие CMS. Калькулятор — серверный компонент, рендерящий HTML с ценами из БД. **Никаких iframe, API-виджетов или скриптов с framemuse.ru не обнаружено.**

В Tailwind-проекте — полностью клиентская замена. `CalcInit(cfg)` принимает конфиг и строит UI. Цены — hardcoded defaults в `calc.js` (строки 82–90). Формула расчёта — в функции `calculate()` (строка ~710). Отправка заказа — заглушка (`console.log` + `alert`).

---

### B. Что работает, что заглушка

#### Статус по страницам

| Страница | Статус | Что конкретно |
|---|---|---|
| `calc.html` | **Эталон-demo** | Полный UI + JS, lazy-init через IntersectionObserver |
| `foto-na-kholste-sankt-peterburg.html` | **Работает** | Единственная production-страница с рабочим калькулятором: `CalcInit({ type: 'canvas' })` |
| `pechat-na-kholste-sankt-peterburg.html` | **Заглушка** | Текст «Калькулятор будет добавлен при интеграции с Bitrix» |
| `portret-maslom.html` | **Заглушка (pilot-ready)** | Dashed-box «Будет загружен из Bitrix» |
| 22 страницы portret-na-zakaz | **Заглушка** | Идентичный dashed-box |

**Итого: 1 рабочий калькулятор, 1 демо-эталон, 24 заглушки.**

#### Устройство calc.html (252 строки)

**Роль:** эталонная standalone-страница для разработки и тестирования. Не предназначена для production, но служит source of truth для разметки и компонентных классов.

**Структура HTML:**

```
<section id="calc" data-calc-root>
  ├── <h2>Цена</h2>
  ├── #calc-main-layout (flex → колонки)
  │   ├── ЛЕВАЯ: #uploader-zone + #calc-preview-column
  │   │   ├── .room-bg (фон интерьера)
  │   │   └── .calc-preview-canvas (превью холста + рамки)
  │   └── ПРАВАЯ: .calc-panel
  │       ├── Размер (#size-section) — пресеты + custom input
  │       ├── Печать и подрамник (.wrap-btn × 3: стандарт/галерея/рулон)
  │       ├── Обработка фото (#processing-select: базовая/оптимальная/премиальная)
  │       ├── Оформление в багет (#frame-section → модалка)
  │       ├── Покрытие лаком (#toggle-varnish, .calc-checkbox)
  │       ├── Подарочная упаковка (#toggle-gift)
  │       └── Итого: #total-price, #old-price
  ├── #order-form-container (.calc-order-form) — имя/телефон/email + отправка
  └── #mobile-sticky-bar (.calc-sticky-bar) — мобильный итого

<dialog id="frame-modal" class="modal-shell">
  └── Каталог багетов: STUDIO (15) + CLASSIC (12), превью рамки

<div id="lightbox"> — полноэкранный просмотр
```

**Формула ценообразования (`calc.js`, функция `calculate()`):**

```
area       = (w × h) / 10 000   (м²)
perimeter  = (w + h) × 2 / 100  (м)
base       = area × 2 500 ₽/м²
stretcher  = perimeter × 500 ₽/м  (0 для рулона)
gallery    = GALLERY ? perimeter × 300 ₽/м : 0
varnish    = checked ? area × 800 ₽/м² : 0
gift       = checked ? 450 ₽ : 0
frameCost  = frame ? perimeter × 1 200 ₽/м × (CLASSIC ? 1.5 : 1) : 0
processing = 0 | 300 | 900 ₽
total      = ceil(base + stretcher + gallery + varnish + gift + frameCost + processing)
old_price  = total / 0.8  (фейковая скидка 20%)
```

**Работающие функции:**
- Расчёт цены (площадь × ставка + периметр × ставка + опции)
- Визуализатор: превью холста с рамкой в контексте интерьера
- Каталог 27 багетов в нативном `<dialog>` с анимацией
- Выбор размера: пресеты (portrait/landscape/square) + ручной ввод (20–200 см)
- 3 типа подрамника: стандартный, галерейный (+доплата), рулон (−20%)
- Обработка фото: 3 уровня (0 / +300₽ / +900₽)
- Toggles: лак, подарочная упаковка
- Загрузка фото (drag-and-drop, до 20 файлов, MIME/размер)
- Auto-ориентация по загруженному фото
- DPI-индикатор (предупреждение о качестве)
- Lightbox для полноэкранного просмотра

**НЕ работает / заглушка:**
- Отправка заказа = `console.log` + `alert`
- Портретные опции: HTML-секции hidden (`#calc-faces-section` и т.д.), JS-логика не реализована
- Серверная валидация цен: отсутствует

#### Расхождения между эталоном и интегрированной страницей

| Аспект | calc.html (эталон) | foto-na-kholste (интегрированный) |
|---|---|---|
| Модалка багета | `<dialog class="modal-shell">` | `<div>` c inline z-index (legacy) |
| Панель | `.calc-panel` компонент | Inline Tailwind-классы |
| Toggles | `.calc-checkbox` | Switch-стиль (`.rounded-full`) |
| Инициализация | Lazy: IntersectionObserver + requestIdleCallback | Прямой `DOMContentLoaded` |
| `data-calc-root` | Есть | Нет |
| Портретные секции | Нет | 6 скрытых секций (hidden) |

**Этот дрифт — технический долг. Нужно привести foto-na-kholste к эталону calc.html перед rollout.**

---

### D. Риски

| # | Риск | Вероятность | Влияние | Описание |
|---|---|---|---|---|
| 1 | **Расхождение цен** | Высокая | Критическое | Цены hardcoded в JS. При изменении на production (Bitrix) — Tailwind-версия покажет устаревшие. Нет синхронизации. |
| 2 | **Дрифт эталона** | Уже есть | Среднее | calc.html и foto-na-kholste уже разошлись (модалка, toggles, классы). При rollout на 23 страницы расхождения будут множиться. |
| 3 | **Дубли формул** | Средняя | Высокое | Legacy `draft/calculator.html` содержит другую формулу: `basePrices = { '30x40': 4371, '40x60': 5293 }` — фиксированные цены vs. площадная формула в calc.js. |
| 4 | **Портретные опции не реализованы** | Факт | Блокирующее | В calc.js нет логики для: кол-во лиц, гель, акрил, масло, поталь, цифровой макет. HTML есть, но hidden и не привязан к calculate(). |
| 5 | **Отправка заказа = заглушка** | Факт | Блокирующее для launch | `initOrderForm()` → `console.log` + `alert`. Нет реальной отправки. |
| 6 | **Нет серверной валидации** | Факт | Высокое | Пользователь может изменить цены через DevTools. Нет серверного перерасчёта. |
| 7 | **Каталог багетов статичен** | Факт | Среднее | 27 рамок hardcoded. Добавление требует правки JS + деплоя. На production управляется через админку. |
| 8 | **Документация отстаёт** | Средняя | Низкое | DESIGN_SYSTEM.md описывает компоненты, но не формулы и data flow. INTEGRATION_BITRIX.md не упоминает калькулятор. |
| 9 | **Нет тестов** | Факт | Среднее | Нет unit/e2e для calculate(). Любое изменение формулы = ручная проверка. |

---

### E. Варианты архитектуры

#### Вариант 1: File-Based (текущий)

Все цены, багеты и формулы — в `calc.js` + page-config в каждом HTML.

- **Плюсы:** нулевая зависимость от backend; работает на Vercel/Netlify; быстрый рендер (нет сетевых запросов).
- **Минусы:** обновление цены = правка JS + деплой; 23 страницы × inline-config = дубли; нет серверной валидации.
- **Сложность:** низкая.
- **Подходит если:** цены меняются < 1 раз/квартал, багеты стабильны.

#### Вариант 2: Hybrid (file + данные с сервера)

`calc.js` остаётся клиентским. При инициализации — `fetch('/api/prices.json')` за ценами и каталогом багетов. Fallback на hardcoded defaults.

- **Плюсы:** цены обновляются без редеплоя фронта; каталог багетов актуален; graceful degradation; один эндпоинт для всех страниц.
- **Минусы:** нужен backend-эндпоинт (JSON на muse.ooo или Vercel Edge Function); задержка при загрузке (решаемо — defaults → обновление при ответе).
- **Сложность:** средняя.
- **Подходит если:** цены 1–2 раз/месяц, багеты чаще, нужна возможность обновления без разработчика.

#### Вариант 3: Full API (серверный расчёт)

Клиент отправляет параметры, сервер считает цену и возвращает breakdown.

- **Плюсы:** единая формула на сервере, невозможно подменить через DevTools, A/B тестирование цен.
- **Минусы:** зависимость от API (latency, downtime); нужен полноценный backend; сложность ×3.
- **Сложность:** высокая.
- **Подходит если:** высокий трафик, частые изменения формул, юридические требования.

#### Вариант 4: Full Bitrix (как на production)

Калькулятор остаётся компонентом Bitrix. Tailwind-страницы подключают через серверный include.

- **Плюсы:** единый источник (Битрикс БД); админка для менеджеров; проверенная система.
- **Минусы:** привязка к Битрикс-серверу; Tailwind-страницы не могут быть статическими; сложная стилизация; блокирует деплой на Vercel.
- **Сложность:** средняя (если Bitrix настроен).
- **Подходит если:** конечная цель — вернуться в Битрикс, а Tailwind — только шаблон.

---

### F. Рекомендация (цены 1 раз/месяц, багеты чаще)

**Рекомендация: Вариант 2 — Hybrid** с поэтапным переходом.

**Фаза 1 (сейчас → 2 недели): File-Based.**
- `calc.js` с defaults — уже работает.
- Вынести page-config в `<script type="application/json" id="calc-config">` в каждом HTML.
- Rollout на пилотные страницы.

**Фаза 2 (месяц 2): Hybrid.**
- `/api/calc-config.json` на muse.ooo (или Vercel Edge Function) — выгрузка из Bitrix 1 раз/день по cron.
- `CalcInit()` → fetch → при успехе перезаписывает defaults → при ошибке работает на defaults.
- Каталог багетов из того же JSON.
- Менеджер обновляет цены в Битрикс-админке → через час на всех страницах.

**Фаза 3 (при необходимости):** переход к Full API для серверной валидации заказа.

**Обоснование:** при 1 раз/месяц file-based достаточен на старте — не стоит блокировать rollout ожиданием API. Hybrid решает проблему багетов и убирает необходимость деплоя. Graceful degradation: если API недоступен — калькулятор работает.

---

### G. Пошаговый rollout (уточнённый)

#### Batch 0 — Стабилизация эталона (prerequisite)

1. Привести `foto-na-kholste-sankt-peterburg.html` к разметке эталона `calc.html`: `<dialog>`, `.calc-panel`, `.calc-checkbox`, `data-calc-root`, lazy-init.
2. Убедиться что `CalcInit(cfg)` одинаково работает на calc.html и foto-na-kholste.
3. Удалить или пометить deprecated: `draft/calculator.html` (конфликтующие формулы).

#### Batch 1 — Пилот портретов (2 страницы)

| Приоритет | Страница | Почему |
|---|---|---|
| P0 | `portret-maslom.html` | Самый популярный стиль, pilot-ready |
| P0 | `foto-na-kholste-spb.html` | Уже работает, нужна стабилизация (Batch 0) |

**Задачи:**
- Реализовать портретные опции в `CalcInit`: `faces`, `gel`, `acrylic`, `oil`, `potal`, `digitalMockup`.
- Активировать hidden-секции через `cfg.type = 'portrait'`.
- Добавить page-config для portret-maslom.
- Верифицировать цены с production.

#### Batch 2 — Популярные стили (5 страниц)

`portret-karandashom`, `sharzh-po-foto`, `portret-v-obraze`, `pop-art-portret`, `drim-art-portret`.

Заменить заглушки на `CalcInit({ type: 'portrait', ... })` с page-config.

#### Batch 3 — Оставшиеся стили + pechat (13 страниц)

12 оставшихся стилей + `pechat-na-kholste-sankt-peterburg.html` (type: 'canvas').

#### Batch 4 — Объекты портретов (5 страниц)

`muzhskoy`, `zhenskiy`, `detskiy`, `parnyy`, `semeynyy` — могут наследовать единый конфиг.

#### Batch 5 — Расширение (будущие новые типы)

| Страница | Тип | Примечание |
|---|---|---|
| Модульная картина | Конструктор | Новый тип CalcInit |
| Фотоколлаж на холсте | Конструктор | Новый тип CalcInit |
| Фото в рамке | canvas + frame required | Вариация существующего |
| Фотоколлаж в рамке | Конструктор + рамка | Новый тип |

---

### H. Критерии готовности (DoD) и чек-лист

#### DoD — для каждой страницы

| # | Критерий | Как проверить |
|---|---|---|
| 1 | Заглушка «Будет загружен из Bitrix» удалена | Визуально + grep `border-dashed` в `#calc` |
| 2 | `CalcInit(cfg)` вызывается с правильным page-config | DevTools Console: без ошибок |
| 3 | Цена 20×30 совпадает с production (допуск ±5%) | Сравнить с muse.ooo |
| 4 | Все опции (лак, упаковка, обработка) влияют на итого | Включить/выключить, проверить сумму |
| 5 | Каталог багетов: модалка → выбор → превью | Клик → проверка |
| 6 | Загрузка фото: drag-drop + кнопка | Загрузить JPEG < 10 МБ |
| 7 | Mobile sticky-bar показывает итого | Viewport < 768px |
| 8 | Форма валидирует имя/телефон | Пустая отправка → ошибки |
| 9 | Lighthouse Performance ≥ 85 | `npx lighthouse <url>` |
| 10 | Нет console.error | F12 → Console |
| 11 | Разметка соответствует эталону calc.html | `<dialog>`, `.calc-panel`, `.calc-checkbox` |
| 12 | JSON-LD цена обновлена | Schema.org validator |

#### Чек-лист после релиза каждого Batch

- [ ] Все страницы загружаются без JS-ошибок
- [ ] Цены совпадают с production ±5% (таблица сравнения)
- [ ] Мобильная: sticky-bar, scrollable пресеты, touch-friendly toggles
- [ ] Десктоп: двухколоночный layout, модалка багетов, lightbox
- [ ] Кросс-браузер: Chrome, Safari, Firefox (последние 2 версии)
- [ ] Доступность: Tab-навигация, screen reader
- [ ] `<dialog>` fallback для Safari < 15.4 (или polyfill)
- [ ] `draft/calculator.html` помечен deprecated
- [ ] `docs/DESIGN_SYSTEM.md` обновлён: формулы, page-config API, портретные опции
- [ ] `docs/INTEGRATION_BITRIX.md` обновлён: эндпоинт для Hybrid (Фаза 2)
- [ ] Мониторинг через 24ч после деплоя: нет 404, нет regression
---

### I. Решение по варианту архитектуры (13 февраля 2026)

**Принято: Вариант 1 (File-Based).** Серверная часть — позже, при необходимости.

#### Краткое обоснование (по итогам обсуждения)

1. **Производительность.** Вариант 1 — самый быстрый (Lighthouse 95–100). Расчёт цены происходит в браузере за 1–5 мс, 0 сетевых запросов. Серверный расчёт (V3) добавляет 100–500 мс на каждый клик — заметная пауза для пользователя.

2. **React / фреймворки не нужны.** Добавляют 40–50 KB JavaScript, замедляют загрузку, решают другую задачу (удобство разработки, не скорость). Текущий `calc.js` (25 KB) работает мгновенно.

3. **Сервер не ускоряет расчёт — он ускоряет управление.** Единственное преимущество серверных вариантов — менять цены без деплоя. При текущей частоте (1 раз/месяц) это не критично.

4. **Путь к обновлению цен без сервера:** менеджер ставит задачу → разработчик правит конфиг → деплой (5–15 мин). При необходимости: cron-скрипт генерирует `prices.json` из Bitrix, авто-деплой через git push — скорость та же, обновление без разработчика.

 

**Обновлено:** 16 февраля 2026

##### Статус пилотных страниц (Batch 1)

| Страница | Тип | Статус | CalcInit |
|----------|-----|--------|----------|
| `src/html/calc.html` | demo/эталон | ✅ Готов | `CalcInit({ type: 'canvas' })` |
| `src/html/foto-na-kholste-sankt-peterburg.html` | canvas | ✅ Калькулятор работает | `CalcInit({ type: 'canvas' })` |
| `src/html/portret-na-zakaz/style/portret-maslom.html` | portrait | ✅ Калькулятор работает | `CalcInit({ type: 'portrait', tooltips: {...} })` |

##### Что сделано за сессии 1–5 (14–16 февраля 2026)

**calc.html (эталон):**
- ✅ Полный двухколоночный грид: превью (row 1) + форма (row 2) слева, calc-panel (row-span-2, sticky) справа
- ✅ 5 секций: размер (пресеты + ввод), печать/подрамник, обработка фото, багет (dialog-модалка), лак + упаковка
- ✅ Каталог 27 багетов в `<dialog>`, lightbox, mobile sticky-bar
- ✅ Lazy-init: IntersectionObserver + requestIdleCallback

**portret-maslom.html (портрет):**
- ✅ Калькулятор полностью интегрирован, заглушка «Будет загружен из Bitrix» удалена
- ✅ Грид идентичен calc.html: превью + форма слева, calc-panel (row-span-2, sticky) справа
- ✅ Портретные опции через JS-генерацию (`buildPortraitSections()`):
  - Количество лиц (select 1–10)
  - Покрытие гелем, Прорисовка акрилом, **Прорисовка маслом** (бейдж «Популярное»), Покрытие поталью
  - Покрытие лаком (по умолчанию ВКЛ), Подарочная упаковка
  - Цифровой макет (отключает физические опции)
- ✅ Группировка: секции покрытия объединены в одну группу «Покрытие и обработка» с `space-y-2` (−128px высоты панели)
- ✅ Inline checkbox pattern: одна строка `[✓] Label [?] price` без дублирования
- ✅ Матрица совместимости: лак↔гель(✗), лак↔масло(✗), гель↔масло(✗), акрил↔масло(✗)
- ✅ Tooltips для всех опций (включая лак и упаковку) через `<dialog>` модалку
- ✅ Размеры: на десктопе показываются пресеты + кнопка «Свой размер» (как на мобиле)
- ✅ Разделитель перед «Цифровой макет» с подзаголовком «Без изготовления картины»

**calc.js (общий runtime):**
- ✅ ~1 500 строк, единый для всех страниц через `CalcInit(cfg)`
- ✅ Портретный режим: `cfg.type === 'portrait'` → buildPortraitSections, compatibility engine, toggleDigitalMockupMode
- ✅ Система подсказок: `initHintSystem()`, `HINT_TITLES`, `showHint()`, `createHintBtn()`
- ✅ Полный расчёт: площадь × ставка + периметр × ставка + опции + портретные покрытия

##### Текущая задача: единый конфиг цен (`prices.js`) — РЕАЛИЗОВАНО

**Создан `src/html/js/prices.js`** (16 февраля 2026) — единый файл цен для всех калькуляторов.

Архитектура:
```
prices.js (единый источник цен)
    ↓
CalcInit({ prices: MUSE_PRICES.portrait })  ← portret-maslom.html
CalcInit({ prices: MUSE_PRICES.canvas })    ← foto-na-kholste.html
    ↓
calc.js: var PRICES = cfg.prices || DEFAULT_PRICES  ← fallback
```

**Портретные формулы (единицы: см², см):**

| Опция | Формула | Пример 30×40 |
|-------|---------|-------------|
| Печать+подрамник | `0.29·S + 0.04·P·strPrice + 0.76·P + 1998.48` | 2 632 р. (станд.) |
| Подрамник: стандартный | strPrice = 32 | — |
| Подрамник: толстый | strPrice = 68 | 2 834 р. |
| Подрамник: рулон | strPrice = 32 (= стандартный) | 2 632 р. |
| Лицо (1-е) | 1 920 р. | 1 920 р. |
| Лицо (каждое след.) | +960 р. | — |
| Лицо — цифр. макет (1-е) | 3 600 р. | 3 600 р. |
| Лицо — цифр. макет (след.) | +1 200 р. | — |
| Лак | `S × 0.1` | 120 р. |
| Гель | `S × 0.375` | 450 р. |
| Акрил | `S × 1.05` | 1 260 р. |
| Масло | `S × 2 + (лица − 1) × 2 400` | 2 400 р. (1 лицо) |
| Поталь | `S × 0.3` | 360 р. |
| Обработка: базовая | 0 р. | — |
| Обработка: оптимальная | 499 р. | — |
| Обработка: премиальная | 999 р. | — |
| Упаковка ≤ 50×70 | 650 р. | 650 р. |
| Упаковка ≤ 60×90 | 750 р. | — |
| Упаковка ≤ 90×120 | 1 200 р. | — |
| Упаковка > 90×120 | по согласованию | — |

**Статус:** ✅ Реализовано.

##### Единый контент модальных окон

Описания в модальных окнах калькулятора (багет, обработка, покрытия и др.) должны быть **едиными для всех калькуляторов** и редактироваться из одного места (общий конфиг или shared-файл), чтобы исключить рассинхрон текстов между страницами.

##### Порядок секций в портретном калькуляторе

```
 1) Размер, см            — пресеты + «Свой размер»
 2) Подрамник и печать     — Стандартный / Толстый / Рулон
 3) Количество лиц        — select 1–10
 4) Покрытие и обработка   — группа с section-title, space-y-2:
    ├── Покрытие лаком     — checkbox (вкл. по умолчанию)
    ├── Покрытие гелем     — checkbox + tooltip
    ├── Прорисовка акрилом — checkbox + tooltip
    ├── Прорисовка маслом  — checkbox + tooltip + бейдж «Популярное»
    └── Покрытие поталью   — checkbox + tooltip
 5) Багетная рама          — карточка → модалка каталога
 6) Подарочная упаковка    — checkbox + tooltip
 ─── разделитель ───
 7) Цифровой макет         — checkbox (отключает пп. 2–6)
```

##### Decision Gate (Pilot Gate)

- ✅ Пилот 1 (`foto-na-kholste-sankt-peterburg.html`) — калькулятор работает
- ✅ Пилот 2 (`portret-maslom.html`) — калькулятор работает, портретные опции реализованы
- ✅ Цены — единый конфиг `prices.js` подключён (ожидаем только цену масла)
- ⏳ Проверка скорости — Lighthouse + Web Vitals до/после подключения `prices.js`
- Далее: если стабильно и быстро → масштабируем на Batch 2 (5 style-страниц)