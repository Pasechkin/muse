# Интеграция с Bitrix

## Общие сведения

Шаблоны подготовлены для интеграции с 1С-Битрикс. Все динамические элементы помечены комментариями или заглушками.

---

## Получение репозитория

### Клонирование (рекомендуется)

```bash
git clone https://github.com/ваш-username/muse-tailwind.git
```

Репозиторий публичный — коллаборация не требуется для чтения.

### Альтернатива: скачать ZIP

GitHub → кнопка "Code" → "Download ZIP"

---

## Структура файлов для Bitrix

### Что копировать из репозитория

| Файл/папка | Путь в репозитории | Назначение |
|------------|-------------------|------------|
| CSS (основной) | `src/css/output.css` | Основные стили (генерируется сборкой) |
| CSS (info-страницы) | `src/css/page-info.css` | Стили для info-страниц |
| JS | `src/html/js/nav.js` | Скрипты навигации |
| Иконки | `src/html/icons/` | SVG-иконки |
| Изображения | `src/html/images/` | Картинки |
| HTML-страницы | `src/html/` | Исходники для конвертации в PHP |

### Рекомендуемая структура в Bitrix

```
local/
└── templates/muse/
    ├── css/
    │   ├── output.css
    │   └── page-info.css
    ├── js/
    │   └── nav.js
    ├── images/
    ├── icons/
    ├── header.php
    ├── footer.php
    └── components/
```

---

## Процесс интеграции

### Начальная настройка (один раз)

1. Клонировать репозиторий или скачать ZIP
2. Скопировать в шаблон Bitrix:
   - `src/css/output.css` — основные стили
   - `src/css/page-info.css` — стили info-страниц
   - `src/html/js/nav.js` — скрипты навигации
   - `src/html/icons/` — иконки
   - `src/html/images/` — изображения
3. Конвертировать HTML-страницы в PHP-шаблоны
4. Заменить заглушки на Bitrix-компоненты

### Обновления

```
Разработчик Tailwind          Программист Bitrix
        │                            │
        │  git push (main)           │
        │  ─────────────────────►    │  git pull
        │                            │  (получает обновления)
        │                            │
        │                            │  переносит изменения в шаблоны
```

| Что изменилось | Что обновлять в Bitrix |
|----------------|------------------------|
| Стили | Заменить `output.css` и `page-info.css` |
| Скрипты | Заменить `nav.js` |
| Разметка страницы | Перенести изменения в PHP-шаблон |
| Новая страница | Создать новый PHP-шаблон |

### Команды Git

```bash
# Первый раз — клонировать
git clone https://github.com/ваш-username/muse-tailwind.git

# Получить обновления
cd muse-tailwind
git pull
```

### Сборка CSS (когда нужна пересборка)

**Когда нужна пересборка:**
- Добавили/удалили/переименовали Tailwind-классы в HTML или JS (любые `class="..."` или строки с классами в JS)
- Изменили `src/input.css` или правила `@theme`/`@utility`/`@layer`
- Поменяли структуру/пути так, что нужно править `@source` в `input.css`

**Когда пересборка НЕ нужна:**
- Меняли только текст, ссылки, изображения, alt/title, порядок блоков
- Заменяли заглушки на Bitrix-компоненты, но классы остались теми же
- Добавили/изменили серверный PHP-код без изменения классов

```bash
# Установить зависимости (первый раз)
npm install

# Собрать CSS
npm run build:once
npm run copy-css
```

---

## Автономная работа (без GitHub)

После интеграции можно работать без постоянной связи с репозиторием.

### Когда GitHub больше не нужен

- Все страницы переверстаны и интегрированы
- Стили стабильны и не требуют изменений
- Разработчик Tailwind больше не вносит правки

### Что сохранить для автономной сборки

| Файл/папка | Назначение |
|------------|------------|
| `src/input.css` | Исходник стилей Tailwind |
| `src/html/` | HTML-файлы (Tailwind сканирует классы) |
| `package.json` | Список npm-зависимостей |
| `postcss.config.js` | Конфигурация сборки |

### Сборка без GitHub

Требуется Node.js 18+ ([nodejs.org](https://nodejs.org/))

```bash
# В папке проекта
npm install          # установить зависимости (первый раз)
npm run build:once   # собрать output.css
npm run copy-css     # скопировать в html/css/
```

### Альтернатива: работа без сборки

Если не хотите ставить Node.js — не редактируйте Tailwind-классы:

1. Используйте готовый `output.css` как есть
2. Свои CSS-правки добавляйте в отдельный файл `bitrix-custom.css`
3. Подключайте оба:

```html
<link rel="stylesheet" href="/local/templates/muse/css/output.css">
<link rel="stylesheet" href="/local/templates/muse/css/bitrix-custom.css">
```

### Риски полного отказа от репозитория

| Риск | Последствие |
|------|-------------|
| Нет истории изменений | Сложно понять, что менялось |
| Нет отката | Если что-то сломается — нет бэкапа |
| Потеря исходников | При потере сервера HTML-эталоны пропадут |

**Рекомендация:** сохраните копию репозитория как архив, даже если не планируете его вести.

---

## Совместная работа (контрибьютор)

Если программист Bitrix должен вносить изменения в репозиторий — добавьте его как коллаборатора.

### Настройка

1. GitHub → Settings → Collaborators → Add people
2. Указать GitHub-аккаунт программиста
3. Он получит доступ на запись

### Рекомендуемый workflow

```
Разработчик Tailwind (main)     Программист Bitrix (своя ветка)
        │                              │
        │                              │  git checkout -b bitrix-fixes
        │                              │  (работает в своей ветке)
        │                              │
        │   ◄─── Pull Request ──────   │  (предлагает изменения)
        │                              │
        │  review + merge              │
```

### Разделение зон ответственности

| Кто | Что редактирует |
|-----|-----------------|
| Разработчик Tailwind | `src/input.css`, документация (`docs/`) |
| Программист Bitrix | PHP-шаблоны (вне репозитория), может предлагать правки в HTML |

### Преимущества

- Синхронизация изменений в одном месте
- Общая история версий
- Оба видят изменения друг друга

### Риски

| Риск | Как избежать |
|------|--------------|
| Конфликты при merge | Работать в отдельных ветках |
| Случайная перезапись | Делать Pull Request, а не push в main |
| Сломанная сборка | Проверять изменения перед merge |

### Упрощённый вариант

Если workflow с ветками слишком сложен — разрешите push в main, но договоритесь:
- Программист не трогает `src/input.css`
- Перед push делает `git pull`
- Коммиты с понятными сообщениями

---

## Важные правила

### НЕ редактировать

- `output.css` — генерируется сборкой Tailwind, изменения затрутся
- `src/input.css` — исходник для Tailwind (редактирует только разработчик Tailwind)

### Можно

- Добавить свой `bitrix-custom.css` после `output.css` для локальных правок
- Изменять PHP-шаблоны
- Заменять заглушки на Bitrix-компоненты

### Документация

| Файл | Содержание |
|------|------------|
| `docs/DESIGN_SYSTEM.md` | Все CSS-классы и компоненты |
| `docs/INTEGRATION_BITRIX.md` | Этот файл — заглушки и OAuth |
| `PROJECT.md` | Эталонные страницы |

### Эталонные страницы

| Тип | Файл |
|-----|------|
| Стили портретов | `src/html/portret-na-zakaz/style/portret-maslom.html` |
| Главная | `src/html/index.html` |
| Info-страницы | `src/html/info/kontakty.html` |

---

## Модальное окно отзывов (OAuth)

### Эталон
Файл: `src/html/portret-na-zakaz/style/portret-maslom.html`

На остальных страницах секция «Отзывы» упрощена до заглушки — при интеграции использовать структуру из эталона.

### BxPopup

В `src/html/js/nav.js` (строка 9) есть fallback-функция для OAuth popup:

```javascript
window.BxPopup = function(url, width, height) {
    var left = (screen.width - width) / 2;
    var top = (screen.height - height) / 2;
    window.open(url, 'oauth', 'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top);
};
```

**Если Bitrix предоставляет свою реализацию `BxPopup`** — эту функцию можно удалить из `nav.js`.

Скрипты сборки описаны в package.json в разделе scripts: npm run build:once запускает PostCSS и собирает output.css, а npm run copy-css копирует output.css и page-info.css в папку src/html/css/ для предпросмотра.

### OAuth URL

В шаблоне используются плейсхолдеры:
- `YOUR_CLIENT_ID`
- `YOUR_REDIRECT_URI`

Bitrix должен генерировать актуальные URL с:
- Валидным `check_key` (сессионный токен)
- Правильным `backurl` (текущая страница)
- `code_challenge` для VK (PKCE)

### Паттерн onclick

```html
<a href="https://oauth.provider.ru/..." 
   onclick="if(typeof BxPopup==='function'){BxPopup(this.href, 680, 600); return false;}">
```

- Если `BxPopup` доступен — открывает popup
- Если нет — fallback на обычный переход по `href`

### Размеры popup по провайдерам

| Провайдер | Ширина | Высота |
|-----------|--------|--------|
| Яндекс | 680 | 600 |
| VK | 660 | 425 |
| Google | 580 | 400 |
| Mail.Ru | 580 | 400 |
| Одноклассники | 580 | 400 |

---

## Калькулятор цены

> **Полная техническая документация калькулятора:** [docs/CALCULATOR.md](CALCULATOR.md)

В Tailwind-проекте реализован полностью клиентский калькулятор. Серверная часть (Bitrix) должна предоставить endpoint'ы для интеграции.

### Текущее состояние

Калькулятор работает на 2 продуктовых страницах + 1 демо-эталон:
- `calc.html` — демо/эталон (source of truth для разметки)
- `foto-na-kholste-sankt-peterburg.html` — тип `canvas`
- `portret-maslom.html` — тип `portrait`

### Файлы, которые использует калькулятор

| Файл | Назначение |
|------|------------|
| `js/prices.js` | Конфиг цен (`MUSE_PRICES`) + тексты подсказок (`MUSE_TOOLTIPS`) |
| `js/calc.js` | Движок калькулятора (UI, формулы, каталог рам, визуализатор) |
| `js/uploader.js` | Загрузчик изображений (drag-drop, валидация, ресайз) |

Порядок подключения: `prices.js` → `calc.js` → `uploader.js` (все с `defer`).

### Что нужно от Bitrix (серверные endpoint'ы)

| Endpoint | Метод | Назначение | Приоритет |
|----------|-------|------------|----------|
| `/api/order` | POST | Приём заказа (данные клиента + параметры продукта + ID загруженных фото) | **Обязательно** |
| `/api/upload` | POST | Приём фотографий (multipart, до 20 файлов × 10 МБ) | **Обязательно** |
| `/api/frames.json` | GET | Каталог багетных рам с флагом наличия (`available: true/false`) | Рекомендуется |
| `/api/prices.json` | GET | Полный конфиг цен (формат = `MUSE_PRICES` из `prices.js`) | На будущее |

Подробный контракт API, форматы запросов/ответов и fallback-поведение → см. [CALCULATOR.md, раздел 10](CALCULATOR.md#10-требования-к-серверной-части).

### Важно: серверная валидация цены

`totalPrice` в заказе — расчёт на клиенте (может быть подменён через DevTools). Сервер **должен пересчитать** цену по своим формулам/таблицам.

---

## Галерея / Портфолио

Секции с `id="primery-portretov"` содержат заглушки для галерей из Bitrix.

---

## Отзывы из Bitrix

Список отзывов загружается динамически. Заглушка:

```html
<div class="text-center text-gray-500 py-8 mb-8">
    <p class="text-sm">Отзывы будут загружены из Bitrix</p>
</div>
```
